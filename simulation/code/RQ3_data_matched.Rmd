--- 
title: "mediation_sim" 
output: html_document 
date: "2025-02-14" 
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
```

# Load and Setup 
```{r} 
source("../../setup/external.R")
output_path <- "../output/" 
library(truncnorm)
# Attrition in experimental data
# Use test scores starting from grade 1. New York data only has Grade 3 scores. 

star <- read_dta(file.path(external_path, "star/STAR_extract.dta")) %>% 
  select(smalli, smallk, small1, small2, small3, avsumk, avsum1, avsum2, avsum3, avsum4, avsum5, avsum6, avsum7, avsum8, newsch,female,lunch,race,white) %>% 
  drop_na(smalli, smallk, small1, small2, small3, avsumk, avsum1, avsum2, avsum3, avsum4, avsum5, avsum6, avsum7, avsum8) 
```

# Clean Data
```{r}
set.seed(50) 
n_new <- 11559

# Rename the column 'lunch3' to 'lunch'
colnames(star)[colnames(star) == "lunch3"] <- "lunch"

# Add the 'black' column to star_raw where race equals 2
star$black <- ifelse(star$race == 2, 1, 0)
star$asian <- ifelse(star$race == 3, 1, 0) 
star$hispanic <- ifelse(star$race == 4, 1, 0)
star$native <- ifelse(star$race == 6, 1, 0)

## Replicate the covariate and treatment characteristics of the population 
covars <- c("female", "lunch", "white", "black", "asian", "hispanic", "native", "smallk")
covars_min <- setdiff(covars, c("smallk"))

star_extract <- star %>%
  group_by(across(all_of(covars_min))) %>%
  mutate(covar_min_id = cur_group_id()) %>%
  group_by(across(all_of(covars))) %>%
  summarize(
    n = n(),
    covar_id = cur_group_id(), 
    covar_min_id = first(covar_min_id),
    probability = n / nrow(star),
    # Summarize test scores by covar group 
    mean_k = mean(avsumk), 
    sd_k = sd(avsumk), 
    min_k = min(avsumk), 
    max_k = max(avsumk), 
    k_1_diff = mean(avsum1) - mean(avsumk)
  ) %>%
  drop_na(sd_k) 

# Multinomial draw from ID's
draws <- rmultinom(1, size = n_new, prob = star_extract$probability)
# Turn into vector
covars <- rep(star_extract$covar_id, times = draws)

data <- data.frame(
  ID = 1:n_new, 
  covar_id = covars
) %>%
  group_by(covar_id) %>%
  left_join(star_extract, by = "covar_id") 

# Draw Small K 
# Suppose social skills are measured on same scale as test scores, with approximately same distribution within & across covariate groups
data$social_k <- rnorm(n_new,  data$mean_k, data$sd_k) 
data$test_k <- rnorm(n_new,  data$mean_k, data$sd_k) 

data <- data %>%
  select(-covar_id, -probability, -n, -mean_k, -sd_k)

# Draw attrition & entrance as essentially random across covar groups, conditioned on previous treat status 
star %>% 
  filter(small2 == 0) %>%
  summary()

data$small1 <- case_when(
  data$smallk == 1 ~ rbinom(n_new, 1, 0.9445),
  data$smallk == 0 ~ rbinom(n_new, 1, 0.07109), 
)
data$small2 <- case_when(
  data$small1 == 1 ~ rbinom(n_new, 1, 0.9842), 
  data$small1 == 0 ~ rbinom(n_new, 1, 0.03849)
)
data$small3 <- case_when(
  data$small2 == 1 ~ rbinom(n_new, 1, 0.991),
  data$small2 == 0 ~ rbinom(n_new, 1, 0.04228)
)

## Balance Check
summary(star)
summary(data)
```

# Generation of Data
```{R}
set.seed(50)
# Define Skill Generation Parameters 
sigma <- 5
gamma_ncog <- 0.95
gamma_cog <- 0.5
phi <- 0.7

data <- data %>% 
  group_by(covar_min_id) %>%
  mutate(
    mean_test_k_0 = mean(test_k[smallk == 0], na.rm = T), 
    mean_social_k_0 = mean(social_k[smallk == 0], na.rm = T), 
    mean_test_k_1 = mean(test_k[smallk == 1], na.rm = T), 
    mean_social_k_1 = mean(social_k[smallk == 1], na.rm = T), 
    mean_test_overall = mean(test_k, na.rm = T), 
    mean_social_overall = mean(social_k, na.rm = T)
  ) %>%
  group_by(covar_id) %>%
  mutate(
    mean_test_k = mean(test_k, na.rm = T), 
    mean_social_k = mean(social_k, na.rm = T)
  )

# Assume there is a discontinuous shift in environment from k to 1
data[["test_1"]] <- gamma_cog * data[["test_k"]] + (1-gamma_cog) * (data[["mean_test_k"]] + data[["k_1_diff"]]) + rnorm(n_new, mean = 0, sd = sigma)
data[["social_1"]] <- gamma_ncog * data[["test_k"]] + (1-gamma_ncog) * (data[["mean_social_k"]] + data[["k_1_diff"]]) + rnorm(n_new, mean = 0, sd = sigma)

data <- data %>% 
  group_by(covar_min_id) %>%
  mutate(
    mean_test_1_0 = mean(test_k[smallk == 0], na.rm = T), 
    mean_social_1_0 = mean(test_k[smallk == 0], na.rm = T)
  ) %>%
  group_by(covar_id) %>%
  mutate(
    mean_test_1 = mean(test_1, na.rm = T), 
    mean_social_1 = mean(test_1, na.rm = T)
  )
  
# For each grade, calculate the "counter-factual" environment 
grades <- c(1,2,3,4,5,6,7,8)

generate_data <- function(gamma_cog, gamma_ncog){
  for (skill in c("test_", "social_")) {
    if (skill == "test_") {
      gamma <- gamma_cog
    } else {
      gamma <- gamma_ncog 
    }
    
    for (grade in 2:3) {
    prev_col <- paste0(skill, grade - 1)
    curr_col <- paste0(skill, grade) 
    treatment <- paste0("small", grade)
    
    phi <- 1
    test_indicator <- as.numeric(skill == "test")
    
    # Weight previous skills by gamma, and baseline environment by (1-Gamma)
    # Skills become more self-productive over time 
    data[[curr_col]] <<- (((gamma + grade*0.02) * (data[[prev_col]]))^phi + ((1-gamma - grade*0.02) * (data[[paste0("mean_", skill, "1_0")]] + test_indicator * grade * 0.2 + data[["black"]] * 2))^phi)^(1/phi)  + rnorm(n_new, mean = 0, sd = sigma)
    }
    for (grade in 4:8){
    prev_col <- paste0(skill, grade - 1)
    curr_col <- paste0(skill, grade) 
    
    data[[curr_col]] <<- (((gamma + grade*0.02) * (data[[prev_col]]))^phi + ((1-gamma - grade*0.02) * (data[[paste0("mean_", skill, "1_0")]] + test_indicator * grade * 0.2 + data[["black"]] * 2))^phi)^(1/phi)  + rnorm(n_new, mean = 0, sd = sigma)
    }
  }
}

generate_data(0.60, 0.85)
```


```{r}
set.seed(633)
data$small_class_participation <- rowMeans(data[, c("smallk", "small1", "small2", "small3")], na.rm = TRUE)
star$small_class_participation <- rowMeans(star[, c("smallk", "small1", "small2", "small3")], na.rm = TRUE)

define_treat_flow <- function(data) {
  data$treat_flow <- case_when(
    data$smallk == 0 & data$small1 == 0 & data$small2 == 0 & data$small3 == 0 ~ "never", 
    data$smallk == 1 & data$small1 == 0 & data$small2 == 0 & data$small3 == 0 ~ "to k", 
    data$smallk == 1 & data$small1 == 1 & data$small2 == 0 ~ "to 1", 
    data$smallk == 1 & data$small1 == 1 & data$small2 == 1 & data$small3 == 0 ~ "to 2", 
    data$smallk == 1 & data$small1 == 1 & data$small2 == 1 & data$small3 == 1 ~ "to 3", 
    TRUE ~ "NA"
  )
  return(data)
}

data <- define_treat_flow(data)
star <- define_treat_flow(star)
```

# Regressions 
```{r}
regress <- function(y, x, covars, df){
  formula <- as.formula(paste0(y, " ~ ", paste(x, collapse = " + "), " + ", paste(covars, collapse = " + ")))
  feols(formula, data = df)
}

plot_coefs <- function(df, df_star, filter_str, covar_list, name) {
  if(!is.na(filter_str)) {
    # Parse_expr takes a string and converts into EXPRESSION to be evaluated 
    filter_str <- rlang::parse_expr(filter_str)
  
    df <- df %>%
      # Bang Bang to unquote 
      filter(!!filter_str)
    df_star <- df_star %>%
      filter(!!filter_str)
  }
  
  # Regress Smallk on Short-run Test Scores for filtered data
  modk <- regress("test_k", "smallk", covar_list, df)
  mod1 <- regress("test_1", "smallk", covar_list, df)
  mod2 <- regress("test_2", "smallk", covar_list, df)
  mod3 <- regress("test_3", "smallk", covar_list, df)
  mod4 <- regress("test_4", "smallk", covar_list, df)
  mod5 <- regress("test_5", "smallk", covar_list, df)
  mod6 <- regress("test_6", "smallk", covar_list, df)
  mod7 <- regress("test_7", "smallk", covar_list, df)
  mod8 <- regress("test_8", "smallk", covar_list, df)

  modk_star <- regress("avsumk", "smallk", covar_list, df_star)
  mod1_star <- regress("avsum1", "smallk", covar_list, df_star)
  mod2_star <- regress("avsum2", "smallk", covar_list, df_star)
  mod3_star <- regress("avsum3", "smallk", covar_list, df_star)
  mod4_star <- regress("avsum4", "smallk", covar_list, df_star)
  mod5_star <- regress("avsum5", "smallk", covar_list, df_star)
  mod6_star <- regress("avsum6", "smallk", covar_list, df_star)
  mod7_star <- regress("avsum7", "smallk", covar_list, df_star)
  mod8_star <- regress("avsum8", "smallk", covar_list, df_star)
  
  # Prepare tables for plotting
  table_test <- data.frame(
    Grade = c(0,1,2,3,4,5,6,7,8), 
    Effect_of_KSize = c(coef(modk)["smallk"], coef(mod1)["smallk"], coef(mod2)["smallk"], coef(mod3)["smallk"], coef(mod4)["smallk"], coef(mod5)["smallk"], coef(mod6)["smallk"],coef(mod7)["smallk"], coef(mod8)["smallk"])
  )
  
  table_test_star <- data.frame(
  Grade = c(0,1,2,3,4,5,6,7,8), 
  Effect_of_KSize = c(coef(modk_star)["smallk"], coef(mod1_star)["smallk"], coef(mod2_star)["smallk"], coef(mod3_star)["smallk"],
                      coef(mod4_star)["smallk"], coef(mod5_star)["smallk"], coef(mod6_star)["smallk"], coef(mod7_star)["smallk"],
                      coef(mod8_star)["smallk"]),
  SE = c(sqrt(diag(vcov(modk_star)))["smallk"], sqrt(diag(vcov(mod1_star)))["smallk"], 
         sqrt(diag(vcov(mod2_star)))["smallk"], sqrt(diag(vcov(mod3_star)))["smallk"], 
         sqrt(diag(vcov(mod4_star)))["smallk"], sqrt(diag(vcov(mod5_star)))["smallk"], 
         sqrt(diag(vcov(mod6_star)))["smallk"], sqrt(diag(vcov(mod7_star)))["smallk"], 
         sqrt(diag(vcov(mod8_star)))["smallk"]
  )
  )
  
  # Regress for social scores on Short-run Test Scores for filtered data
  modk <- regress("social_k", "smallk", covar_list, df)
  mod1 <- regress("social_1", "smallk", covar_list, df)
  mod2 <- regress("social_2", "smallk", covar_list, df)
  mod3 <- regress("social_3", "smallk", covar_list, df)
  mod4 <- regress("social_4", "smallk", covar_list, df)
  mod5 <- regress("social_5", "smallk", covar_list, df)
  mod6 <- regress("social_6", "smallk", covar_list, df)
  mod7 <- regress("social_7", "smallk", covar_list, df)
  mod8 <- regress("social_8", "smallk", covar_list, df)
  
  # Prepare social table
  table_social <- data.frame(
    Grade = c(0,1,2,3,4,5,6,7,8), 
    Effect_of_KSize = c(coef(modk)["smallk"], coef(mod1)["smallk"], coef(mod2)["smallk"], coef(mod3)["smallk"], coef(mod4)["smallk"], coef(mod5)["smallk"], coef(mod6)["smallk"], coef(mod7)["smallk"],coef(mod8)["smallk"])
  )
  
  # Plot both effects
  file_path <- paste0("simulation_", name, ".pdf")
  
  pdf(file.path(output_path, file_path), width = 12, 7)
  p <- ggplot() + 
    geom_point(data = table_test, aes(x = Grade, y = Effect_of_KSize, color = "Test Scores (Simulated)"), size = 2) + 
    geom_line(data = table_test, aes(x = Grade, y = Effect_of_KSize, color = "Test Scores (Simulated)")) + 
    geom_point(data = table_social, aes(x = Grade, y = Effect_of_KSize, color = "Non-Cognitive Scores (Simulated)"), size = 2) + 
    geom_line(data = table_social, aes(x = Grade, y = Effect_of_KSize, color = "Non-Cognitive Scores (Simulated)")) + 
    geom_point(data = table_test_star, aes(x = Grade, y = Effect_of_KSize, color = "Test Scores (STAR)"), size = 2) + 
    geom_line(data = table_test_star, aes(x = Grade, y = Effect_of_KSize, color = "Test Scores (STAR)")) + 
    geom_ribbon(data = table_test_star, 
              aes(x = Grade, ymin = Effect_of_KSize - SE, ymax = Effect_of_KSize + SE, fill = "grey"), 
              alpha = 0.2) + 
    labs(
      x = "Grade", 
      y = "Effect of KG Class Quality",
      title = paste0("Impact of KG Class Quality on Skills for ", name, " Students"),
      color = "Score Type"
    ) + 
    scale_color_manual(values = c("Test Scores (Simulated)" = "brown", "Non-Cognitive Scores (Simulated)" = "darkolivegreen", "Test Scores (STAR)" = "darkorange")) + 
    scale_fill_manual(values = c("grey" = "grey")) + 
    guides(fill = "none") + 
    theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm"), 
          plot.title = element_text(size = 13, face = "bold", hjust = 0.5))
  print(p)
  dev.off()
  print(p)
}

# Basic Plot
plot_coefs(data, star, NA, covars_min, "All")
plot_coefs(data, star, "white == 1 & lunch == 1", c("female"), "White, Free Lunch")
plot_coefs(data, star, "white == 1 & lunch == 0", c("female"), "White, No Free Lunch")
plot_coefs(data, star, "black == 1 & lunch == 1", c("female"), "Black, Free Lunch")
#plot_coefs(data, star, "white == 1", c("lunch", "female"), "White")
```


# Data Cleaning 
```{r}

make_long_data <- function(covars) {
  data_long <- data %>%
    select(all_of(covars), matches("^social_|^test_")) %>%
    pivot_longer(cols = matches("^social_|^test_"), 
               names_to = c(".value", "Grade"),
               names_pattern = "(.*)_(\\d+|k)"
               ) %>% 
    mutate(Grade = ifelse(Grade == "k", 0, as.numeric(Grade))) %>%
    arrange(Grade) %>%
    group_by(Grade, !!!syms(covars)) %>%
    summarize(mean_social = mean(social, na.rm = T), 
            mean_test = mean(test, na.rm = T))
  
  return(data_long)
}

make_long_star <- function(covars) {
  star_long <- star %>%
  select(all_of(covars), matches("^avsum")) %>%
  pivot_longer(cols = matches("^avsum"), 
        names_to = c(".value", "Grade"), 
        names_pattern = "(.*)(\\d+|k)"
  ) %>%
  mutate(Grade = ifelse(Grade == "k", 0, as.numeric(Grade))) %>%
    arrange(Grade) %>%
    group_by(Grade, !!!syms(covars)) %>%
    summarize(mean_test = mean(avsum, na.rm = T))

  return(star_long)
}

```


##### Graphs for Inspecting ##### 
```{r}
pdf(file.path(output_path, "matched_simulation_plots_bygroup.pdf"), width = 11, 7)

# Set 1
data_long <- make_long_data(c("black", "white", "lunch", "treat_flow"))
star_long <- make_long_star(c("black", "white", "lunch", "treat_flow"))

ggplot() + 
  geom_line(data = star_long %>% filter(black == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (STAR)")) +
  geom_line(data = data_long %>% filter(black == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (Simulated)")) + 
  geom_line(data = data_long %>% filter(black == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_social, color = "Non-Cognitive Score (Simulated)")) +
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm"))  + 
  labs(
    x = "Grade", 
    y = "Mean Score", 
    title = "Mean Scores over Time for Treated Black, Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(white == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (STAR)")) +
  geom_line(data = data_long %>% filter(white == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (Simulated)")) + 
  geom_line(data = data_long %>% filter(white == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_social, color = "Non-Cognitive Score (Simulated)")) +
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Score", 
    title = "Mean Scores over Time for Treated White, Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(black == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (STAR)")) +
  geom_line(data = data_long %>% filter(black == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (Simulated)")) + 
  geom_line(data = data_long %>% filter(black == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_social, color = "Non-Cognitive Score (Simulated)")) +
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Score", 
    title = "Mean Scores over Time for Treated Black, No Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(white == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (STAR)")) +
  geom_line(data = data_long %>% filter(white == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (Simulated)")) + 
  geom_line(data = data_long %>% filter(white == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_social, color = "Non-Cognitive Score (Simulated)")) +
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated White, No Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

# Set 2
data_long <- make_long_data(c("female", "lunch", "black", "white", "treat_flow"))
star_long <- make_long_star(c("female", "lunch", "black", "white", "treat_flow"))

ggplot() + 
  geom_line(data = star_long %>% filter(female == 1 & black == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (STAR)")) +
  geom_line(data = data_long %>% filter(female == 1 & black == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Test Score (Simulated)")) + 
  geom_line(data = data_long %>% filter(female == 1 & black == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_social, color = "Non-Cognitive Score (Simulated)")) +
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated Black, Female, Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(female == 1 & black == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(female == 1 & black == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated Black, Female, No Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(female == 1 & white == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(female == 1 & white == 1 & lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated White, Female, Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(female == 1 & white == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(female == 1 & white == 1 & lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated White, Female, No Free Lunch Students",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

# Set 3 
data_long <- make_long_data(c("lunch", "treat_flow"))
star_long <- make_long_star(c("lunch", "treat_flow"))

ggplot() + 
  geom_line(data = star_long %>% filter(lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(lunch == 1 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated Students Receiving Free Lunch",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(lunch == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm")) + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Treated Students Not Receiving Free Lunch",
    color = "Data Type", 
    caption = "* for students treated until grade 3"
  )
dev.off()
```
```{r}
data_long <- make_long_data(c("black", "white", "lunch", "female", "treat_flow"))
star_long <- make_long_star(c("black", "white", "lunch", "female", "treat_flow"))

ggplot() + 
  geom_line(data = star_long %>% filter(black == 1 & lunch == 1 & female == 1 & treat_flow == "never"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(black == 1 & lunch == 1 & female == 1 & treat_flow == "never"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Mean Scores over Time for Black, Female, Free Lunch Students",
    color = "Data Type"
  )

ggplot() + 
  geom_line(data = star_long %>% filter(white == 1 & lunch == 0 & female == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "STAR Data")) +
  geom_line(data = data_long %>% filter(white == 1 & lunch == 0 & female == 0 & treat_flow == "to 3"), aes(x = Grade, y = mean_test, color = "Simulated Data")) + 
  theme_minimal() + 
  labs(
    x = "Grade", 
    y = "Mean Test Score", 
    title = "Impact of KG Class Quality for Black, Female, Free Lunch Students",
    color = "Data Type"
  )
```

# Other Overview Plots
```{r}
ggplot(data = data_long, aes(x = Grade)) + 
    geom_line(aes(y = mean_social, color = "Social Skills")) + 
    geom_line(aes(y = mean_test, color = "Test Scores")) + 
    labs(
      x = "Grade",
      y = "Mean Scores",
      title = "Mean Social Skills and Test Scores over Time by Class-size Treatment",
      color = "Legend"  # Title of the legend
    ) + 
    facet_wrap(~ smallclassparticipation, scales = "free") + 
    theme_minimal() + 
    theme(plot.margin = margin(4, 4, 4, 4, unit = "cm"))
```

```{r}
# Compute mean for test scores
data$MeanTestScores <- rowSums(data[, c("TestScores_3", "TestScores_4", 
                                        "TestScores_5", "TestScores_6", 
                                        "TestScores_7", "TestScores_8")], na.rm = TRUE)

# Compute mean for test scores
data$MeanSocialSkills <- rowSums(data[, c("SocialSkills_3", "SocialSkills_4", 
                                        "SocialSkills_5", "SocialSkills_6", 
                                        "SocialSkills_7", "SocialSkills_8")], na.rm = TRUE)

# Returns on test scores 
alpha_0 <- 15000
alpha_1 <- 100 
# Returns on social skills 
alpha_2 <- 100
alpha_3 <- 100
sigma_earnings <- 5000  # Standard deviation of earnings noise

# Generate Earnings
data$Earnings <- alpha_0 +
  alpha_1 * data$MeanTestScores + # Measurable cognitive skills 
  500 * data$latent_cog + # Some influence from latent ability 
  alpha_2 * data$MeanSocialSkills +
  alpha_3 * data$SmallClassParticipation + 
  rnorm(n_new, mean = 0, sd = sigma_earnings)

# Summarize the dataset
summary(data[, c("SocialSkills_3", "SocialSkills_8", "TestScores_3", "TestScores_8", "MeanTestScores", 
                 "MeanSocialSkills", "SmallClassParticipation", "Earnings")])

```


```{r}
ggplot(data = data %>%
         select(Earnings, SmallClassParticipation) %>%
         group_by(SmallClassParticipation) %>%
         summarize(mean_earnings = mean(Earnings))
         , aes(x = SmallClassParticipation)) + 
  geom_point(aes(y = mean_earnings, color = "Earnings"), size = 2) + 
  labs(
    x = "Treatment Class", 
    y = "Mean Earnings", 
    title = "Mean Earnings by Exposure to Small Pre-k Classrooms"
  ) + 
  theme_minimal()
```


```{r}
library(fixest) # For econometric modeling (e.g., feols)

# 1. Baseline Estimators
# (i) Using cognitive test scores only
baseline_cog_model <- lm(Earnings ~ MeanTestScores, data = data)
summary(baseline_cog_model)

# (ii) Using both cognitive and non-cognitive measures
baseline_cog_ncog_model <- lm(Earnings ~ MeanTestScores + MeanSocialSkills, data = data)
summary(baseline_cog_ncog_model)

# (iii) Using all cognitive, non-cognitive, and latent cognitive measures 
baseline_combined_model <- lm(Earnings ~ MeanTestScores + MeanSocialSkills + latent_cog, data = data)
summary(baseline_combined_model)

# (iv) True Causal Effect, controlling for all latent factors 
true_model <- lm(Earnings ~ latent_cog + latent_ncog + SmallClassParticipation, data = data)
summary(true_model)

# 2. Surrogate Estimator
# Define treatment (W) as small class participation
data$W <- data$SmallClassParticipation

# (i) Estimate gamma (E[Y2 | Y1, G=O])
surrogate_gamma_model <- lm(Earnings ~ MeanTestScores, data = data)
gamma <- coef(surrogate_gamma_model)["MeanTestScores"]

# (ii) Estimate beta (E[Y1 | W, G=E])
surrogate_beta_model <- lm(MeanTestScores ~ W, data = data)
beta <- coef(surrogate_beta_model)["W"]

# Surrogate estimate: gamma * beta
surrogate_estimate <- gamma * beta
cat("Surrogate Estimate:", surrogate_estimate, "\n")

# 3. LU Estimator
# (i) Estimate gamma1 and gamma2 (E[Y2 | Y1, W, G=O])
lu_gamma_model <- lm(Earnings ~ MeanTestScores + W, data = data)
gamma1 <- coef(lu_gamma_model)["MeanTestScores"]
gamma2 <- coef(lu_gamma_model)["W"]

# (ii) Use the same beta from surrogate model
# LU estimate: gamma1 * beta + gamma2
lu_estimate <- gamma1 * beta + gamma2
cat("LU Estimate:", lu_estimate, "\n")

#4. ACME Estimator 
acme_gamma_model <- lm(Earnings ~ MeanTestScores + W + MeanTestScores*W, data = data)
gamma1 <- coef(acme_gamma_model)["MeanTestScores"]
gamma2 <- coef(acme_gamma_model)["W"]

acme_estimate <- gamma1 * beta + gamma2

# Compare Results
results <- data.frame(
  Method = c("Baseline - Test Only", "Baseline - Test and Non-Cognitive", "Baseline - Test, Non-Cognitive, IQ", "True Causal Effect of Class Size", "Surrogate", "ACME", "LU"),
  Estimate = c(
    coef(baseline_cog_model)["MeanTestScores"],
    coef(baseline_cog_ncog_model)["MeanTestScores"],
    coef(baseline_combined_model)["MeanTestScores"],
    coef(true_model)["SmallClassParticipation"],
    surrogate_estimate,
    acme_estimate, 
    lu_estimate
  )
)
print(results)
```



